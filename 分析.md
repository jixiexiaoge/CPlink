# CarrotAmap-706 7706端口JSON数据字段逆向分析

## 概述

本文档详细分析了CarrotAmap-706项目中通过7706端口发送给comma3设备的JSON数据字段，包括每个字段的来源、功能、数据类型和映射关系。

## 数据流向架构

```
高德地图广播 → Android应用 → Comma3设备 → OpenPilot控制
     ↓              ↓            ↓            ↓
  导航数据      JSON字段映射    SDI处理逻辑   速度控制
```

## 7706端口JSON数据字段详细分析

### 1. 基础通信字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| carrotIndex | Long | ✅ | 数据包序号 | 12345 | 计算/本地生成 | - | 数据同步，每包递增 |
| epochTime | Long | ✅ | Unix时间戳 | 1703123456 | 计算/本地生成 | - | 时间同步，每60包发送一次 |
| timezone | String | ✅ | 时区 | "Asia/Shanghai" | 计算/本地生成 | - | 默认Asia/Shanghai |
| heading | Double | ✅ | 方向角(0-360度) | 45.5 | Amap导航或手机GPS | 10065: BEARING | GPS方向角，优先导航GPS |
| carrotCmd | String | ✅ | 命令类型 | "navigation_data" | 计算/本地生成 | - | 控制命令类型 |
| carrotArg | String | ✅ | 命令参数 | "" | 计算/本地生成 | - | 命令参数 |

### 2. GPS定位字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| latitude | Double | ✅ | GPS纬度(WGS84) | 39.9042 | Amap导航或手机GPS | 10065: LATITUDE | 优先导航GPS，超时3秒切换手机GPS |
| longitude | Double | ✅ | GPS经度(WGS84) | 116.4074 | Amap导航或手机GPS | 10065: LONGITUDE | 优先导航GPS，超时3秒切换手机GPS |
| accuracy | Double | ✅ | GPS精度(米) | 3.2 | 手机GPS | 手机传感器 | GPS定位精度 |
| gps_speed | Double | ✅ | GPS速度(m/s) | 12.5 | 手机GPS | 手机传感器 | GPS速度 |

### 3. 目的地信息字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| goalPosX | Double | ✅ | 目标经度 | 116.4074 | Amap | 10001: endPOILongitude | 导航目的地经度 |
| goalPosY | Double | ✅ | 目标纬度 | 39.9042 | Amap | 10001: endPOILatitude | 导航目的地纬度 |
| szGoalName | String | ✅ | 目标名称 | "天安门广场" | Amap | 10001: endPOIName | 导航目的地名称 |

### 4. 道路信息字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| nRoadLimitSpeed | Integer | ✅ | 道路限速(km/h) | 60 | Amap | 10001: LIMITED_SPEED 或 12110: SPEED_LIMIT | 当前道路限速，防抖处理 |
| roadcate | Integer | ✅ | 道路类别 | 8 | 计算/映射 | 10001: ROAD_TYPE → 映射函数 | 道路宽度分类，10/11=高速，其他=普通道路 |
| szPosRoadName | String | ✅ | 当前道路名称 | "长安街" | Amap | 10001: CUR_ROAD_NAME 或 10003: ROUTE_NAME | 当前所在道路名称 |

### 5. SDI速度检测字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| nSdiType | Integer | ✅ | SDI类型 | 1 | Amap | 13005: CAMERA_TYPE 或 100001: CAMERA_TYPE | 电子眼类型：0=信号超速，1=固定测速，2=区间开始，3=区间结束，4=区间中，22=减速带 |
| nSdiSpeedLimit | Integer | ✅ | 测速限速(km/h) | 50 | Amap | 13005: SPEED_LIMIT 或 100001: CAMERA_SPEED | 测速点限速值 |
| nSdiDist | Integer | ✅ | 到测速点距离(m) | 300 | Amap | 13005: DISTANCE 或 100001: CAMERA_DIST | 距离测速点距离 |
| nSdiSection | Integer | ✅ | 区间测速ID | 12345 | Amap/内部 | 13005 内部字段 | 区间测速唯一标识符 |
| nSdiBlockType | Integer | ✅ | 区间状态 | 1 | Amap/内部 | 13005 内部字段 | 区间状态：1=开始，2=中，3=结束 |
| nSdiBlockSpeed | Integer | ✅ | 区间限速 | 60 | Amap/内部 | 13005 内部字段 | 区间测速限速 |
| nSdiBlockDist | Integer | ✅ | 区间距离 | 2000 | Amap/内部 | 13005 内部字段 | 区间测速总距离 |

### 6. SDI Plus扩展字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| nSdiPlusType | Integer | ✅ | Plus类型 | 22 | Amap | 10007: SDI_TYPE 或 SDI_PLUS_INFO.type | SDI Plus扩展类型，22=减速带 |
| nSdiPlusSpeedLimit | Integer | ✅ | Plus限速 | 30 | Amap | 10007: SPEED_LIMIT 或 SDI_PLUS_INFO.speed_limit | 减速带限速 |
| nSdiPlusDist | Integer | ✅ | Plus距离 | 100 | Amap | 10007: SDI_DIST 或 SDI_PLUS_INFO.distance | 到减速带距离 |
| nSdiPlusBlockType | Integer | ✅ | Plus区间类型 | -1 | Amap(JSON) | 10007: SDI_PLUS_INFO.block_type | 扩展区间状态 |
| nSdiPlusBlockSpeed | Integer | ✅ | Plus区间限速 | 0 | Amap(JSON) | 10007: SDI_PLUS_INFO.block_speed | 扩展区间限速 |
| nSdiPlusBlockDist | Integer | ✅ | Plus区间距离 | 0 | Amap(JSON) | 10007: SDI_PLUS_INFO.block_dist | 扩展区间距离 |

### 7. TBT转弯导航字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| nTBTDist | Integer | ✅ | 转弯距离(m) | 200 | Amap | 10001: SEG_REMAIN_DIS 或 10006: TURN_DISTANCE | 到转弯点距离 |
| nTBTTurnType | Integer | ✅ | 转弯类型 | 12 | Amap+映射 | 10001: ICON/NEW_ICON → 映射, 或 10006: TURN_TYPE | 转弯类型编码，12=左转，13=右转，16=急左转，19=急右转 |
| szTBTMainText | String | ✅ | 主要指令文本 | "前方200米左转" | 计算/拼装 | 10001/10006 + 文本生成 | 导航指令文本 |
| szNearDirName | String | ✅ | 近处方向名 | "建国门" | Amap | 10001: NEXT_ROAD_NAME | 近处地标 |
| szFarDirName | String | ✅ | 远处方向名 | "东二环" | Amap | 10001: NEXT_NEXT_ROAD_NAME | 远处地标 |
| nTBTNextRoadWidth | Integer | ✅ | 下一道路宽度 | 6 | Amap | 13012: drive_way_size(车道线信息) | 车道数，影响转弯控制距离 |
| nTBTDistNext | Integer | ✅ | 下一转弯距离 | 500 | Amap | 10001: NEXT_SEG_REMAIN_DIS 或 10006: NEXT_TURN_DISTANCE | 下下个转弯距离 |
| nTBTTurnTypeNext | Integer | ✅ | 下一转弯类型 | 13 | Amap+映射 | 10001: NEXT_NEXT_TURN_ICON → 映射, 或 10006: NEXT_TURN_TYPE | 下下个转弯类型 |
| szTBTMainTextNext | String | ✅ | 下一转弯指令 | "前方500米右转" | 计算/拼装 | 10001/10006 + 文本生成 | 下下个指令文本 |

### 8. 目的地剩余字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| nGoPosDist | Integer | ✅ | 剩余距离(m) | 5000 | Amap | 10001: ROUTE_REMAIN_DIS | 到目的地距离 |
| nGoPosTime | Integer | ✅ | 剩余时间(s) | 600 | Amap | 10001: ROUTE_REMAIN_TIME 或 10003: ROUTE_TIME | 预计到达时间 |

### 9. 导航位置字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| vpPosPointLat | Double | ✅ | 导航纬度 | 39.9042 | Amap | 10001: CAR_LATITUDE 或 10065: LATITUDE | 导航系统纬度，优先导航字段 |
| vpPosPointLon | Double | ✅ | 导航经度 | 116.4074 | Amap | 10001: CAR_LONGITUDE 或 10065: LONGITUDE | 导航系统经度，优先导航字段 |
| nPosAngle | Double | ✅ | 导航方向角 | 45.5 | Amap/手机 | 10001: CAR_DIRECTION 或 10065: BEARING/手机 | 导航系统方向角 |
| nPosSpeed | Double | ✅ | 导航速度 | 12.5 | Amap/手机 | 10001: CUR_SPEED 或 10065: SPEED/手机 | 导航系统速度 |

### 10. 导航状态字段

| 字段名 | 类型 | 是否发送 | 描述 | 实例数据 | 来源 | 高德KEY_TYPE | 功能说明 |
|--------|------|----------|------|----------|------|--------------|----------|
| isNavigating | Boolean | ✅ | 是否正在导航 | true | Amap | 10042: NAVI_STATUS / 10019: EXTRA_STATE | 导航状态，到达目的地时置false |

## 关键字段详细分析

### roadcate 道路类别字段

**字段含义**: 表示道路宽度，而非道路等级
- **10, 11**: 高速公路（宽道路）
- **0-9**: 普通道路（窄到中等宽度道路）
- **8**: 默认值，中等宽度道路

**处理逻辑**:
```kotlin
// 减速带处理逻辑
if ((nSdiPlusType == 22 || nSdiType == 22) && roadcate > 1 && autoNaviSpeedCtrlMode >= 2) {
    // 减速带处理：高速公路(10,11)不处理减速带，普通道路处理减速带
    xSpdLimit = autoNaviSpeedBumpSpeed
    xSpdDist = if (nSdiPlusType == 22) nSdiPlusDist else nSdiDist
    xSpdType = 22
}
```

### nSdiType SDI类型字段

| nSdiType值 | 中文描述 | 处理逻辑 | 实例数据 |
|------------|----------|----------|----------|
| 0 | 信号超速 | ✅ 处理 | 信号灯处超速检测 |
| 1 | 超速(固定式) | ✅ 处理 | 固定测速摄像头 |
| 2 | 区间测速开始 | ✅ 处理 | 区间测速起点 |
| 3 | 区间测速结束 | ✅ 处理 | 区间测速终点 |
| 4 | 区间测速中 | ✅ 处理 | 区间测速进行中 |
| 7 | 超速(移动式) | ✅ 处理* | 移动测速设备，需要autoNaviSpeedCtrlMode >= 3 |
| 8 | 固定式超速危险区 | ✅ 处理 | 固定危险区域 |
| 22 | 减速带 | ✅ 处理 | 减速带检测，需要roadcate > 1且autoNaviSpeedCtrlMode >= 2 |
| 75,76 | 特殊测速类型 | ✅ 处理 | 特殊测速设备 |
| 其他 | 其他类型 | ❌ 不处理 | 默认值-1，不处理 |

### nTBTTurnType 转弯类型字段

| nTBTTurnType值 | 转弯类型 | 修饰符 | xTurnInfo | 中文描述 |
|----------------|----------|--------|-----------|----------|
| 12 | turn | left | 1 | 左转 |
| 13 | turn | right | 2 | 右转 |
| 16 | turn | sharp left | 1 | 急左转 |
| 19 | turn | sharp right | 2 | 急右转 |
| 14 | turn | uturn | 7 | 掉头 |
| 6,43,73,74,117,123,124 | fork | right | 4 | 分叉(右) |
| 7,44,75,76,118 | fork | left | 3 | 分叉(左) |
| 101,104,111,114 | off ramp | slight right | 4 | 右匝道(轻微) |
| 102,105,112,115 | off ramp | slight left | 3 | 左匝道(轻微) |
| 131-142 | rotary | 各种 | 5 | 环岛 |
| 201 | arrive | straight | 8 | 到达 |
| 51-55 | notification | straight | 0 | 通知类 |

## 数据来源映射总览

### 高德广播KEY_TYPE与字段映射

| 字段名 | 来源KEY_TYPE | Amap Extra字段名 | 说明 |
|--------|--------------|------------------|------|
| szPosRoadName | 10001 | CUR_ROAD_NAME | 当前道路名 |
| szNearDirName | 10001 | NEXT_ROAD_NAME | 近处方向名 |
| szFarDirName | 10001 | NEXT_NEXT_ROAD_NAME | 远处方向名 |
| nRoadLimitSpeed | 10001/12110 | LIMITED_SPEED / SPEED_LIMIT | 限速信息 |
| nGoPosDist | 10001 | ROUTE_REMAIN_DIS | 剩余距离 |
| nGoPosTime | 10001/10003 | ROUTE_REMAIN_TIME / ROUTE_TIME | 剩余时间 |
| nTBTDist | 10001/10006 | SEG_REMAIN_DIS / TURN_DISTANCE | 转弯距离 |
| nTBTTurnType | 10001/10006 | ICON/NEW_ICON(映射) / TURN_TYPE | 转弯类型 |
| nSdiType | 13005/100001 | CAMERA_TYPE | 电子眼类型 |
| nSdiSpeedLimit | 13005/100001 | SPEED_LIMIT / CAMERA_SPEED | 测速限速 |
| nSdiDist | 13005/100001 | DISTANCE / CAMERA_DIST | 测速距离 |
| nSdiPlusType | 10007 | SDI_TYPE 或 SDI_PLUS_INFO.type | SDI Plus类型 |
| nSdiPlusSpeedLimit | 10007 | SPEED_LIMIT 或 SDI_PLUS_INFO.speed_limit | Plus限速 |
| nSdiPlusDist | 10007 | SDI_DIST 或 SDI_PLUS_INFO.distance | Plus距离 |
| isNavigating | 10042/10019 | NAVI_STATUS / EXTRA_STATE | 导航状态 |
| latitude/longitude | 10065 | LATITUDE / LONGITUDE | GPS定位 |
| heading | 10065 | BEARING | GPS方向角 |
| nLaneCount | 13012 | EXTRA_DRIVE_WAY.drive_way_size | 车道数量 |

## 系统架构分析

### 数据同步机制
1. **时间同步**: `carrotIndex`每包递增，`epochTime`每60包发送一次
2. **GPS数据优先级**: 导航GPS优先，超时3秒切换手机GPS
3. **状态管理**: `active_count`数据包计数器，`active_sdi_count`SDI数据计数器

### 速度控制逻辑
1. **多源融合**: ATC、SDI、HDA、道路限速、路线速度等取最小值
2. **减速带处理**: 根据`roadcate`决定是否处理减速带
3. **区间测速**: 通过`nSdiBlockType`管理区间测速状态

### 转弯控制逻辑
1. **ATC控制**: 基于`xTurnInfo`和距离计算转弯控制
2. **道路宽度**: `nTBTNextRoadWidth`影响转弯启动距离
3. **连续转弯**: 支持提前规划连续转弯策略

## 关键处理函数

### 字段映射函数
- `mapAmapIconToCarrotTurn()`: 高德ICON到CarrotMan转弯类型映射
- `mapRoadTypeToRoadcate()`: 高德道路类型到roadcate映射
- `mapTrafficLightStatus()`: 交通灯状态映射

### 数据处理函数
- `convertCarrotFieldsToJson()`: 字段转换为JSON格式
- `getSdiTypeDescription()`: SDI类型文本描述
- `generateDebugText()`: 调试文本生成

## 注意事项

1. **数据格式**: 所有数据通过JSON格式传输，UTF-8编码
2. **精度**: GPS坐标使用双精度浮点数，距离使用米，速度使用km/h或m/s
3. **默认值**: 大部分字段都有合理的默认值
4. **错误处理**: 包含基本的错误处理和数据验证机制
5. **防抖处理**: `nRoadLimitSpeed`存在防抖逻辑，避免瞬时异常
6. **兼容性**: 保持与Python端carrot_serv.py的字段兼容性

## 总结

CarrotAmap-706通过7706端口发送的JSON数据包含40+个字段，涵盖了GPS定位、导航信息、速度检测、转弯控制等核心功能。每个字段都有明确的数据来源、处理逻辑和功能说明，形成了完整的手机到comma3设备的数据通信协议。
